/dts-v1/;
#include <nordic/nrf52840_qiaa.dtsi>

#include <zephyr/dt-bindings/gpio/gpio.h>
#include <zephyr/dt-bindings/led/led.h>

#include "capstonepcb-pinctrl.dtsi"

/ {
	model = "Custom Board auto generated by nRF Connect for VS Code";
	compatible = "batkay,capstonepcb";

	chosen {
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		zephyr,code-partition = &slot0_partition;
	};

	cpus {
		// needed for correct ws2812 timing
        cpu@0 {
            clock-frequency = <64000000>;
        };
    };

	led_enable: regulator {
		compatible = "regulator-fixed";
		regulator-name = "load_switch_3v3";

		enable-gpios = <&gpio0 3 GPIO_ACTIVE_HIGH>;

		// enable-active-high;
		
	};

	buttons {
		compatible = "gpio-keys";
		no-disconnect;
		debounce-interval-ms = <0>;
		button0: button_0 {
			gpios = <&gpio0 6 GPIO_ACTIVE_LOW>;
		};
	};

	led_strip: ws2812 {
		compatible = "worldsemi,ws2812-gpio";

		chain-length = <150>; /* arbitrary */
		color-mapping = <LED_COLOR_ID_GREEN
				 LED_COLOR_ID_RED
				 LED_COLOR_ID_BLUE>;

		gpios = <&gpio0 5 GPIO_ACTIVE_HIGH>;

		reset-delay = <3200>;

        delay-t1h = <51>;
        delay-t1l = <29>;
        delay-t0h = <26>;
        delay-t0l = <54>;
	};

	bat_ind: bat_led {
		compatible = "worldsemi,ws2812-gpio";

		chain-length = <1>; /* arbitrary */
		color-mapping = <LED_COLOR_ID_GREEN
				 LED_COLOR_ID_RED
				 LED_COLOR_ID_BLUE>;

		gpios = <&gpio0 4 GPIO_ACTIVE_HIGH>;

		reset-delay = <3200>;

        delay-t1h = <51>;
        delay-t1l = <29>;
        delay-t0h = <26>;
        delay-t0l = <54>;
	};
	
	

	// pwm

	servo0: servo0 {
		compatible = "pwm-servo";
		pwms = <&pwm0 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		min-pulse = <PWM_MSEC(1)>;
		max-pulse = <PWM_MSEC(2)>;
	};
	
	servo1: servo1 {
		compatible = "pwm-servo";
		pwms = <&pwm1 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		min-pulse = <PWM_MSEC(1)>;
		max-pulse = <PWM_MSEC(2)>;
	};

	servo2: servo2 {
		compatible = "pwm-servo";
		pwms = <&pwm2 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		min-pulse = <PWM_MSEC(1)>;
		max-pulse = <PWM_MSEC(2)>;
	};
	

	aliases {
		led-strip = &led_strip;
		bat-ind = &bat_ind;
		led-enable = &led_enable;
	};
};

&flash0 {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		boot_partition: partition@0 {
			label = "mcuboot";
			reg = <0x00000000 DT_SIZE_K(48)>;
		};

		slot0_partition: partition@c000 {
			label = "image-0";
			reg = <0x0000c000 DT_SIZE_K(472)>;
		};

		slot1_partition: partition@82000 {
			label = "image-1";
			reg = <0x00082000 DT_SIZE_K(472)>;
		};

		storage_partition: partition@f8000 {
			label = "storage";
			reg = <0x000f8000 DT_SIZE_K(32)>;
		};
	};
};

&i2c0 {
	
	compatible = "nordic,nrf-twi";
	status = "okay";
	pinctrl-0 = <&i2c0_default>;
	pinctrl-1 = <&i2c0_sleep>;
	pinctrl-names = "default", "sleep";
	
	apds9960: gesturesensor@39 {
		compatible = "avago,apds9960";
		reg = <0x39>;
		int-gpios = <&gpio1 2 GPIO_ACTIVE_HIGH>;
		vin-supply = <&led_enable>;
		zephyr,deferred-init;
	};

	fuelguage: max17048@6D {
		compatible = "maxim,max17048";
		reg = <0x6D>;
	};
};


&pwm0 {
	pinctrl-0 = <&pwm0_default_custom>;
	pinctrl-1 = <&pwm0_csleep>;
	status = "okay";
	pinctrl-names="default", "sleep";
};

&pwm1 {
	pinctrl-0 = <&pwm1_default_custom>;
	pinctrl-1 = <&pwm1_csleep>;
	status = "okay";
	pinctrl-names="default", "sleep";
};
&pwm2 {
	pinctrl-0 = <&pwm2_default_custom>;
	pinctrl-1 = <&pwm2_csleep>;
	status = "okay";
	pinctrl-names="default", "sleep";
};

dmic: &pdm0 {
	status = "okay";
	pinctrl-0 = <&pdm0_default_alt>;
	pinctrl-names = "default";
	clock-source = "PCLK32M_HFXO";

};

// qspi flash
&qspi {
	status = "okay";
	pinctrl-0 = <&qspi_default>;
	pinctrl-1 = <&qspi_sleep>;
	pinctrl-names = "default", "sleep";
	mx25r64: mx25r6435f@0 {
		compatible = "nordic,qspi-nor";
		reg = <0>;
		/* MX25R64 supports only pp and pp4io */
		writeoc = "pp4io";
		/* MX25R64 supports all readoc options */
		readoc = "read4io";
		sck-frequency = <8000000>;
		jedec-id = [c2 28 17];
		sfdp-bfp = [
			e5 20 f1 ff  ff ff ff 03  44 eb 08 6b  08 3b 04 bb
			ee ff ff ff  ff ff 00 ff  ff ff 00 ff  0c 20 0f 52
			10 d8 00 ff  23 72 f5 00  82 ed 04 cc  44 83 68 44
			30 b0 30 b0  f7 c4 d5 5c  00 be 29 ff  f0 d0 ff ff
		];
		size = <67108864>;
		has-dpd;
		t-enter-dpd = <10000>;
		t-exit-dpd = <35000>;
	};
};

zephyr_udc0: &usbd {
	compatible = "nordic,nrf-usbd";
	status = "okay";
};